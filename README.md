# ๐งช Sandbox Kubernetes Runner

ะญัะพั ัะตัะฒะธั ะฟะพะทะฒะพะปัะตั ะทะฐะฟััะบะฐัั ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะน ะบะพะด ะฒะฝัััะธ ะธะทะพะปะธัะพะฒะฐะฝะฝัั Kubernetes Job'ะพะฒ. ะัะฟะพะปัะทัะตััั ะฒ ััะตะฝะฐัะธัั, ะณะดะต ััะตะฑัะตััั ะฑะตะทะพะฟะฐัะฝะพะต ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะพะธะทะฒะพะปัะฝะพะณะพ ะบะพะดะฐ (ะฝะฐะฟัะธะผะตั, ะพะฑััะตะฝะธะต, ัะตััะพะฒัะต ะพะบััะถะตะฝะธั ะธ ั.ะฟ.).

---

## ๐ ะะปะณะพัะธัะผ ัะฐะฑะพัั

1. ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะปัะตั ะบะพะด (ะฝะฐะฟัะธะผะตั, ะฝะฐ Python) ัะตัะตะท API.
2. ะกะตัะฒะธั ะบะพะดะธััะตั ะตะณะพ ะฒ base64 ะธ ะฟะพะดััะฐะฒะปัะตั ะฒ ัะฐะฑะปะพะฝ Kubernetes Job (Jinja2).
3. Kubernetes ะทะฐะฟััะบะฐะตั Job ั ัะบะฐะทะฐะฝะฝัะผ ะพะฑัะฐะทะพะผ.
4. ะะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ:
   - ะบะพะด ัะพััะฐะฝัะตััั ะฒ ัะฐะนะป ะฒะฝัััะธ `emptyDir`-ัะพะผะฐ;
   - ะทะฐะฟััะบะฐะตััั ั ะฟะพะผะพััั ะธะฝัะตัะฟัะตัะฐัะพัะฐ (ะฝะฐะฟัะธะผะตั, `python code.py`).
5. ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั Job ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะดะฐะปัะตััั (`ttlSecondsAfterFinished`).
6. ะะตะทัะปััะฐัั ะธัะฟะพะปะฝะตะฝะธั ะดะพัััะฟะฝั ัะตัะตะท API (ะธะปะธ ะปะพะณะธัะพะฒะฐะฝะธะต).

---

## ๐งฐ ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

| ะะพะผะฟะพะฝะตะฝั        | ะะตััะธั / ะัะพะฑะตะฝะฝะพััะธ                  |
|------------------|----------------------------------------|
| Python           | >= 3.13                                |
| FastAPI          | ะะตะฑ-ััะตะนะผะฒะพัะบ ะดะปั API                  |
| Uvicorn          | ASGI-ัะตัะฒะตั                            |
| Kubernetes SDK   | ะะฐะฑะพัะฐ ั ะบะปะฐััะตัะพะผ ะธะท Python           |
| Jinja2           | ะจะฐะฑะปะพะฝะธะทะฐัะธั ะผะฐะฝะธัะตััะพะฒ                |
| Poetry           | ะฃะฟัะฐะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพัััะผะธ ะธ ะฑะธะปะดะพะผ      |

---

## โ๏ธ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะัะต ะฟะตัะตะผะตะฝะฝัะต ะทะฐะณััะถะฐัััั ัะตัะตะท `pydantic-settings`.

| ะะฐะทะฒะฐะฝะธะต                    | ะะฟะธัะฐะฝะธะต                                            | ะัะธะผะตั                            |
|-----------------------------|-----------------------------------------------------|------------------------------------|
| `KUBERNETES_NAMESPACE`      | Namespace, ะฒ ะบะพัะพัะพะผ ะทะฐะฟััะบะฐัััั Job'ั             | `default`                          |
| `SANDBOX_IMAGE_PYTHON`      | ะะผั ะพะฑัะฐะทะฐ ะดะปั ะทะฐะฟััะบะฐ Python-ะบะพะดะฐ                 | `denisduginov/sandbox-python`      |
| `CPU_LIMIT`                 | ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ CPU ะดะปั job                         | `500m`                             |
| `MEMORY_LIMIT`              | ะะณัะฐะฝะธัะตะฝะธะต ะฟะพ ะฟะฐะผััะธ                              | `256Mi`                            |
| `JOB_TTL_SECONDS`           | ะงะตัะตะท ัะบะพะปัะบะพ ัะตะบัะฝะด ัะดะฐะปัะตััั ะทะฐะฒะตัััะฝะฝัะน Job     | `60`                               |
| `KUBECONFIG` (ะพะฟัะธะพะฝะฐะปัะฝะพ)  | ะััั ะบ kubeconfig, ะตัะปะธ ะฝะต ะฒ ะบะปะฐััะตัะต              | `/home/user/.kube/config`          |

---

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```text
sandbox/
โ
โโโ api/                          # FastAPI-ะฟัะธะปะพะถะตะฝะธะต
โ   โโโ main.py                   # ะขะพัะบะฐ ะฒัะพะดะฐ ะฒ API
โ   โโโ routers/                  # ะะฐะทะดะตะปะตะฝะฝัะต ัะพััั (run, result ะธ ั.ะฟ.)
โ   โ   โโโ run.py
โ   โ   โโโ result.py
โ   โโโ services/                 # ะะพะณะธะบะฐ ัะฐะฑะพัั ั K8s, ะพัะตัะตะดัะผะธ
โ   โ   โโโ k8s_runner.py
โ   โ   โโโ result_fetcher.py
โ   โโโ schemas/                  # Pydantic-ััะตะผั
โ   โ   โโโ run.py
โ   โโโ config.py                 # ะะฐัััะพะนะบะธ ะฟัะพะตะบัะฐ (env, paths ะธ ั.ะฟ.)
โ
โโโ docker/                      # ะะพะฝัะตะนะฝะตัั ะดะปั ัะฐะทะฝัั ัะทัะบะพะฒ
โ   โโโ python/
โ   โ   โโโ Dockerfile
โ   โ   โโโ run_code.py
โ   โโโ nodejs/
โ   โ   โโโ Dockerfile
โ   โ   โโโ run_code.js
โ   โโโ cpp/
โ   โ   โโโ Dockerfile
โ   โ   โโโ run_code.cpp
โ   โโโ java/
โ       โโโ Dockerfile
โ       โโโ run_code.java
โ
โโโ k8s/                         # K8s-ะผะฐะฝะธัะตััั ะธะปะธ ะณะตะฝะตัะฐัะพัั job'ะพะฒ
โ   โโโ templates/               # Jinja2-ัะฐะฑะปะพะฝั ะดะปั job'ะพะฒ ะฟะพ ัะทัะบะฐะผ
โ   โ   โโโ python_job.yaml.j2
โ   โ   โโโ nodejs_job.yaml.j2
โ   โ   โโโ ...
โ   โโโ generate_job.py          # ะะตะฝะตัะฐัะพั ะผะฐะฝะธัะตััะฐ job ะฟะพ ัะทัะบั
โ
โโโ sandbox_core/                # ะะฑัะฐั ะปะพะณะธะบะฐ ะทะฐะฟััะบะฐ (ะผะพะถะตั ะธัะฟะพะปัะทะพะฒะฐัััั ะธ worker'ะฐะผะธ)
โ   โโโ language_registry.py     # ะะตะตััั ะฟะพะดะดะตัะถะธะฒะฐะตะผัั ัะทัะบะพะฒ
โ   โโโ executor.py              # ะะฐะทะพะฒะฐั ะปะพะณะธะบะฐ ัะฑะพัะบะธ job
โ   โโโ validators.py
โ
โโโ scripts/
โ   โโโ build_images.sh          # CI/CD ะฑะธะปะดะตั ะพะฑัะฐะทะพะฒ ะฟะพ ะฒัะตะผ ัะทัะบะฐะผ
โ   โโโ cleanup_jobs.py          # ะฃะดะฐะปะตะฝะธะต ัััะฐัะตะฒัะธั job'ะพะฒ
โ
โโโ helm/                        # Helm-ัะฐัั ะดะปั ัะฐะทะฒััััะฒะฐะฝะธั API
โ   โโโ sandbox-api/
โ       โโโ ...
โ
โโโ tests/                       # ะฎะฝะธั- ะธ ะธะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
โ   โโโ test_api.py
โ
โโโ poetry.lock                         # ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
โโโ README.md
```


ะัะพะฒะตัะบะฐ ัะฐะฑะพัั:
ะัะธะผะตั ั NodePort + http:
```
curl --location 'http://158.160.170.194:30000/api/run/sync'   --header 'Content-Type: application/json'   --data '{
    "language": "python",
    "code": "a, b = 1, 2\nprint(a + b)"
}'
```
ะัะธะผะตั ั ingress + http + ะดะพะผะตะฝ:
```
curl --location 'http://k8s.duginov.courses/api/run/sync' \
  --header 'Content-Type: application/json' \
  --data-raw '{
    "language": "python",
    "code": "a, b = 1, 2\nprint(a + b)"
}'
```