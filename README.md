# üß™ Sandbox Kubernetes Runner

–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Kubernetes Job'–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö, –≥–¥–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—É—á–µ–Ω–∏–µ, —Ç–µ—Å—Ç–æ–≤—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ç.–ø.).

---

## üöÄ –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ Python) —á–µ—Ä–µ–∑ API.
2. –°–µ—Ä–≤–∏—Å –∫–æ–¥–∏—Ä—É–µ—Ç –µ–≥–æ –≤ base64 –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –≤ —à–∞–±–ª–æ–Ω Kubernetes Job (Jinja2).
3. Kubernetes –∑–∞–ø—É—Å–∫–∞–µ—Ç Job —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.
4. –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
   - –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ `emptyDir`-—Ç–æ–º–∞;
   - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `python code.py`).
5. –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Job –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è (`ttlSecondsAfterFinished`).
6. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ API (–∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ).

---

## üß∞ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –í–µ—Ä—Å–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                  |
|------------------|----------------------------------------|
| Python           | >= 3.13                                |
| FastAPI          | –í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è API                  |
| Uvicorn          | ASGI-—Å–µ—Ä–≤–µ—Ä                            |
| Kubernetes SDK   | –†–∞–±–æ—Ç–∞ —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º –∏–∑ Python           |
| Jinja2           | –®–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤                |
| Poetry           | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∏ –±–∏–ª–¥–æ–º      |

---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `pydantic-settings`.

| –ù–∞–∑–≤–∞–Ω–∏–µ                    | –û–ø–∏—Å–∞–Ω–∏–µ                                            | –ü—Ä–∏–º–µ—Ä                            |
|-----------------------------|-----------------------------------------------------|------------------------------------|
| `KUBERNETES_NAMESPACE`      | Namespace, –≤ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è Job'—ã             | `default`                          |
| `SANDBOX_IMAGE_PYTHON`      | –ò–º—è –æ–±—Ä–∞–∑–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Python-–∫–æ–¥–∞                 | `denisduginov/sandbox-python`      |
| `CPU_LIMIT`                 | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ CPU –¥–ª—è job                         | `500m`                             |
| `MEMORY_LIMIT`              | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–∞–º—è—Ç–∏                              | `256Mi`                            |
| `JOB_TTL_SECONDS`           | –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —É–¥–∞–ª—è–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π Job     | `60`                               |
| `KUBECONFIG` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)  | –ü—É—Ç—å –∫ kubeconfig, –µ—Å–ª–∏ –Ω–µ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ              | `/home/user/.kube/config`          |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
sandbox/
‚îÇ
‚îú‚îÄ‚îÄ api/                          # FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ main.py                   # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ API
‚îÇ   ‚îú‚îÄ‚îÄ routers/                  # –†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ —Ä–æ—É—Ç—ã (run, result –∏ —Ç.–ø.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ run.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ result.py
‚îÇ   ‚îú‚îÄ‚îÄ services/                 # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å K8s, –æ—á–µ—Ä–µ–¥—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ k8s_runner.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ result_fetcher.py
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                  # Pydantic-—Å—Ö–µ–º—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îÇ   ‚îî‚îÄ‚îÄ config.py                 # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (env, paths –∏ —Ç.–ø.)
‚îÇ
‚îú‚îÄ‚îÄ docker/                      # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ python/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run_code.py
‚îÇ   ‚îú‚îÄ‚îÄ nodejs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run_code.js
‚îÇ   ‚îú‚îÄ‚îÄ cpp/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run_code.cpp
‚îÇ   ‚îî‚îÄ‚îÄ java/
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ       ‚îî‚îÄ‚îÄ run_code.java
‚îÇ
‚îú‚îÄ‚îÄ k8s/                         # K8s-–º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã job'–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ templates/               # Jinja2-—à–∞–±–ª–æ–Ω—ã –¥–ª—è job'–æ–≤ –ø–æ —è–∑—ã–∫–∞–º
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ python_job.yaml.j2
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nodejs_job.yaml.j2
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ generate_job.py          # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ job –ø–æ —è–∑—ã–∫—É
‚îÇ
‚îú‚îÄ‚îÄ sandbox_core/                # –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ (–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏ worker'–∞–º–∏)
‚îÇ   ‚îú‚îÄ‚îÄ language_registry.py     # –†–µ–µ—Å—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ executor.py              # –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∫–∏ job
‚îÇ   ‚îî‚îÄ‚îÄ validators.py
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ build_images.sh          # CI/CD –±–∏–ª–¥–µ—Ä –æ–±—Ä–∞–∑–æ–≤ –ø–æ –≤—Å–µ–º —è–∑—ã–∫–∞–º
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_jobs.py          # –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö job'–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ helm/                        # Helm-—á–∞—Ä—Ç –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è API
‚îÇ   ‚îî‚îÄ‚îÄ sandbox-api/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ tests/                       # –Æ–Ω–∏—Ç- –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ test_api.py
‚îÇ
‚îú‚îÄ‚îÄ poetry.lock                         # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md
```


# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–µ–ø–ª–æ—è 

–î–æ–±–∞–≤–ª–µ–Ω workflow —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—É—à–∞ –≤ DockerHub –∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä kubernetes


Kubernetes (Yandex cloud):

–†–µ—Å—É—Ä—Å—ã —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º Helm:

1. Deployment - backend (FastAPI, –ø–æ–¥–Ω–∏–º–∞–µ—Ç Job)
2. Service - ClusterIP (–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥—É —Å –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
3. Ingress - nginx + https + domain
4. Role + RoleBinding - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞ Job –æ—Ç –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (default)
5. ClusterIssuer - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Ç Let`s Encrypt


–ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ workflow
```
git push
```
(–ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–µ–º –≤ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä –ø—Ä–∏–º–µ–Ω–∏—Ç—å kubectl apply -f rbac-ci.yml)
## –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π:
```
helm upgrade --install sandbox .\sandbox-chart\ -n sandbox
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:
–ü—Ä–∏–º–µ—Ä —Å ingress + http + –¥–æ–º–µ–Ω:
```
curl --location 'http://k8s.duginov.courses/api/run/sync' \
  --header 'Content-Type: application/json' \
  --data-raw '{
    "language": "python",
    "code": "a, b = 1, 2\nprint(a + b)"
}'
```

## –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:
```
helm uninstall sandbox
```

## Debug:

### **–í–∞–∂–Ω–æ**
–ü—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –Ω–∞ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ingress-controller —Å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—É—Ç–µ–π (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è HTTP-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ Lets Encrypt):
```
helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --set controller.admissionWebhooks.enabled=false
```
–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º —É–±—Ä–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ SSL –≤ ingress.yml (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è HTTP-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ Lets Encrypt):
 'nginx.ingress.kubernetes.io/ssl-redirect: "true"'
–¢–∞–∫–∂–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cert-manager –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

